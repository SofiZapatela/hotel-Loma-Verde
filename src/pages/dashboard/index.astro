---
import Layout from '../../layouts/Layout.astro';
import DashboardManager from '../../components/DashboardManager.astro'; 

// OBTENER LAS VARIABLES DE ENTORNO PÚBLICAS
// Se recomienda usar el prefijo PUBLIC_ para variables destinadas al cliente
const firebaseConfig = {
    apiKey: import.meta.env.PUBLIC_FIREBASE_API_KEY,
    authDomain: import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN,
    projectId: import.meta.env.PUBLIC_FIREBASE_PROJECT_ID,
};

// CONVERTIR A STRING para pasar al script inlined
const firebaseConfigJson = JSON.stringify(firebaseConfig);
---

<Layout title="Dashboard de Reservas | Hotel">
    <div id="loading-auth" class="min-h-screen flex items-center justify-center bg-[#FAF9F6]">
        <p class="text-[#1F3333] font-medium">Verificando acceso...</p>
    </div>

    <!-- El contenido del dashboard se mostrará aquí si el usuario está autenticado -->
    <div id="dashboard-content" class="hidden min-h-screen bg-[#FAF9F6] p-4 sm:p-8">
        <header class="mb-8 flex justify-between items-center">
    <div>
        <h1 class="font-cormorant text-4xl font-bold text-[#1F3333] mb-2">
            Gestión de Reservas
        </h1>
        <p class="text-[#8B9D6C]">Bienvenido, gestiona el estado de las solicitudes y bloquea fechas.</p>
    </div>

    <div class="flex flex-col items-end space-y-3">
        <button id="btn-add-bloqueo" 
            class="bg-[#1F3333] text-white px-4 py-2 rounded-lg shadow hover:bg-[#8B9D6C] transition">
            + Agregar bloqueo manual
        </button>

        <button id="logout-button" 
            class="px-4 py-2 text-sm rounded-lg bg-red-600 text-white hover:bg-red-700 transition">
            Cerrar Sesión
        </button>
    </div>
</header>

        <!-- Aquí se cargará la tabla de reservas y el calendario -->
        <DashboardManager /> 
    </div>
</Layout>

<script type="module">
    // ** ESTE SCRIPT COMPRUEBA LA SESIÓN AL CARGAR LA PÁGINA **

    // Recuperar la configuración del servidor
    const scriptTag = document.querySelector('script[data-config-index]');
    const firebaseConfigRaw = scriptTag ? scriptTag.dataset.configIndex : null;
    let firebaseConfig;

    try {
        firebaseConfig = JSON.parse(firebaseConfigRaw);
        // Verificar si las claves existen después de la corrección del prefijo
        if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith('undefined')) { 
            throw new Error("Firebase config missing or invalid.");
        }
    } catch (e) {
        console.error("Error al parsear la configuración de Firebase:", e);
        // Si falla, la lógica de autenticación no podrá inicializarse.
    }

    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // Inicializar la aplicación solo si tenemos la configuración
    const app = firebaseConfig ? (getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0]) : null;
    const auth = app ? getAuth(app) : null;
    // Si la app está inicializada, también inicializamos la DB para DashboardManager
    const db = app ? getFirestore(app) : null; 

    const loadingScreen = document.getElementById('loading-auth');
    const dashboardContent = document.getElementById('dashboard-content');
    const logoutButton = document.getElementById('logout-button');

    // 1. Verificar estado de autenticación
    if (auth) {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario autenticado: muestra el dashboard
                loadingScreen.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
            } else {
                // Usuario no autenticado: redirige a la página de login
                window.location.href = '/dashboard/login';
            }
        });
    } else {
        // Fallo crítico: no se pudo inicializar Firebase
        console.error("Fallo de inicialización de Firebase Auth.");
        loadingScreen.innerHTML = '<p class="text-red-600 font-bold">Error de configuración crítica. Revisa las variables de entorno. Asegúrate que tienen el prefijo PUBLIC_ si es necesario.</p>';
    }


    // 2. Manejar el cierre de sesión
    logoutButton.addEventListener('click', async () => {
        if (!auth) return;
        try {
            await signOut(auth);
            // La función onAuthStateChanged detectará el cambio y redirigirá
        } catch (error) {
            console.error("Error al cerrar sesión:", error);
            // Mostrar mensaje de error si fuera necesario
        }
    });
</script>
<!-- INYECTAR LA CONFIGURACIÓN EN EL ELEMENTO SCRIPT -->
<script type="text/javascript" data-config-index={firebaseConfigJson}></script>